generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Core Models for Authentication
model User {
  id              String         @id @default(uuid())
  name            String?
  email           String         @unique
  passwordHash    String
  role            String         @default("USER") // USER, ADMIN, GUIDE, VENDOR
  isEmailVerified Boolean        @default(false)
  avatar          String?
  phone           String?
  bio             String?
  location        String?
  dateOfBirth     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  refreshTokens           RefreshToken[]
  bookings                Booking[]
  reviews                 Review[]
  orders                  Order[]
  chatMessages            ChatMessage[]
  payments                Payment[]
  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, email])
  @@index([token])
  @@index([userId])
  @@index([email])
  @@index([expiresAt])
  @@map("email_verification_tokens")
}

// Simplified Tour Model
model Tour {
  id              String      @id @default(uuid())
  title           String
  slug            String      @unique
  description     String      @db.Text
  shortDescription String?
  images          String?     @db.Text // JSON string of image URLs
  price           Decimal
  discountPrice   Decimal?
  duration        Int         // Duration in days
  maxGroupSize    Int
  difficulty      String      // Easy, Moderate, Challenging
  status          String      @default("DRAFT") // DRAFT, PUBLISHED, SUSPENDED, ARCHIVED
  featured        Boolean     @default(false)
  
  // Location data as strings
  startLocation   String?     @db.Text // JSON string
  locations       String?     @db.Text // JSON string
  
  // Tour details as strings
  included        String?     @db.Text // JSON string
  excluded        String?     @db.Text // JSON string
  itinerary       String?     @db.Text // JSON string
  
  // Metadata
  tags            String?     @db.Text // JSON string
  category        String
  language        String      @default("en")
  
  // SEO
  metaTitle       String?
  metaDescription String?     @db.Text
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  bookings        Booking[]
  reviews         Review[]

  @@index([status, featured])
  @@index([category])
  @@index([slug])
  @@map("tours")
}

// Simplified Booking Model
model Booking {
  id              String        @id @default(uuid())
  bookingNumber   String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  tourId          String
  tour            Tour          @relation(fields: [tourId], references: [id])
  
  // Booking details
  startDate       DateTime
  endDate         DateTime
  adults          Int           @default(1)
  children        Int           @default(0)
  totalPrice      Decimal
  discountAmount  Decimal?
  promoCode       String?
  
  // Status and metadata
  status          String        @default("PENDING") // PENDING, CONFIRMED, CANCELLED, COMPLETED, REFUNDED
  notes           String?       @db.Text
  specialRequests String?       @db.Text
  
  // Participant information as JSON string
  participants    String?       @db.Text
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  payments        Payment[]

  @@index([userId])
  @@index([tourId])
  @@index([status])
  @@index([startDate])
  @@map("bookings")
}

// Simplified Payment Model
model Payment {
  id              String        @id @default(uuid())
  paymentId       String        @unique // External payment ID (Stripe, Chapa)
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  bookingId       String?
  booking         Booking?      @relation(fields: [bookingId], references: [id])
  orderId         String?
  order           Order?        @relation(fields: [orderId], references: [id])
  
  amount          Decimal
  currency        String        @default("USD")
  method          String        // STRIPE, CHAPA, TELEBIRR, CBE_BIRR
  status          String        @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, REFUNDED
  
  // Payment gateway data as JSON string
  gatewayResponse String?       @db.Text
  failureReason   String?       @db.Text
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([status])
  @@index([paymentId])
  @@map("payments")
}

// Simplified Order Model
model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  
  // Order totals
  subtotal        Decimal
  tax             Decimal     @default(0)
  shipping        Decimal     @default(0)
  discount        Decimal     @default(0)
  total           Decimal
  
  // Status and metadata
  status          String      @default("PENDING") // PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED, REFUNDED
  notes           String?     @db.Text
  
  // Shipping information as JSON strings
  shippingAddress String      @db.Text // JSON string
  billingAddress  String?     @db.Text // JSON string
  trackingNumber  String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  payments        Payment[]

  @@index([userId])
  @@index([status])
  @@map("orders")
}

// Simplified Review Model
model Review {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  
  // Review target (tour only for now)
  tourId      String?
  tour        Tour?        @relation(fields: [tourId], references: [id])
  
  rating      Int          // 1-5 stars
  title       String?
  comment     String       @db.Text
  images      String?      @db.Text // JSON string of image URLs
  
  status      String       @default("PENDING") // PENDING, APPROVED, REJECTED
  isVerified  Boolean      @default(false) // Verified purchase/booking
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([tourId])
  @@index([userId])
  @@index([status])
  @@map("reviews")
}

// Simplified Chat Model
model ChatMessage {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  message     String       @db.Text
  response    String?      @db.Text
  language    String       @default("en")
  
  // Message metadata
  messageType String       @default("text") // text, tour_recommendation, etc.
  metadata    String?      @db.Text // JSON string for additional message data
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}